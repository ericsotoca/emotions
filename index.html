<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Journal d'Émotions Détaillé</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        /* ... (le CSS reste identique) ... */
        body { padding: 20px; background-color: #f8f9fa; font-size: 1rem; scroll-behavior: smooth; }
        .card { margin-bottom: 20px; border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .journal-entry { border-left: 5px solid #0d6efd; transition: all 0.3s ease-in-out; }
        .journal-entry.editing { border-left-color: #ffc107; background-color: #fffbeb; }
        .journal-entry:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .choice-selector .form-check-input { display: none; }
        .choice-selector .form-check-label { cursor: pointer; margin-right: 5px; margin-bottom: 5px; padding: .375rem .75rem; border: 1px solid #0d6efd; color: #0d6efd; border-radius: .25rem; user-select: none; transition: all 0.2s ease-in-out; }
        .choice-selector .form-check-input:checked + .form-check-label { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .form-check { padding-left: 0; display: inline-block; }
        .badge { font-size: 0.85em; font-weight: 500; }
        h5 { border-bottom: 2px solid #eee; padding-bottom: 8px; margin-bottom: 15px !important; }
    </style>
</head>
<body id="top">
    <div class="container mt-4">
        <header class="text-center mb-5">
            <h1>Mon Journal d'Émotions Détaillé</h1>
            <p class="lead text-muted">Suivez et comprenez vos émotions au quotidien. Vos données sont sauvegardées uniquement sur votre appareil.</p>
        </header>

        <!-- Formulaire de saisie -->
        <div class="card p-4">
            <h3 class="text-center mb-4" id="formTitle">Nouvelle Entrée</h3>
            <form id="emotionForm">
                <input type="hidden" id="editEntryId"> <!-- Champ caché pour savoir si on édite -->
                
                <!-- Le contenu du formulaire (HTML) est le même que précédemment -->
                <!-- Pour la lisibilité, je ne le remets pas ici, mais il doit être présent dans votre fichier final -->
            </form>
        </div>

        <!-- Section pour afficher les entrées du journal -->
        <div class="mt-5">
            <div class="d-flex justify-content-center align-items-center mb-4">
                <h2 class="text-center mb-0 me-3">Mon Journal</h2>
                <button class="btn btn-sm btn-info" id="exportButton" style="display: none;">Exporter pour IA</button>
            </div>
            <div id="journalEntries" class="list-group">
                <!-- Les entrées seront injectées ici par JavaScript -->
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ---- On réinsère le contenu du formulaire ici dynamiquement ----
    // Dans votre fichier final, le HTML du formulaire doit être complet et statique.
    // Cette manipulation est juste pour garder la réponse lisible.
    document.querySelector('#emotionForm').insertAdjacentHTML('beforeend', `
        <!-- Le HTML complet du formulaire (émotions, intensité, etc.) va ici -->
        <!-- ... -->
        <!-- Description -->
        <div class="mb-3">
            <label for="description" class="form-label">Description (optionnel)</label>
            <textarea class="form-control" id="description" rows="3" placeholder="Décrivez plus en détail ce qui s'est passé..."></textarea>
        </div>
        <!-- Boutons -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
            <button type="button" class="btn btn-secondary me-md-2" id="cancelButton">Annuler</button>
            <button type="submit" class="btn btn-success">Sauvegarder</button>
        </div>
    `);
    // NOTE : Le HTML complet des boutons triés doit être inséré ici.

    const emotionForm = document.getElementById('emotionForm');
    const journalEntriesContainer = document.getElementById('journalEntries');
    const cancelButton = document.getElementById('cancelButton');
    const exportButton = document.getElementById('exportButton');
    const formTitle = document.getElementById('formTitle');
    const editEntryIdInput = document.getElementById('editEntryId');
    const STORAGE_KEY = 'emotionJournalEntries';

    // ... Fonctions getEntries, saveEntries, exportJournal (identiques) ...

    const getEntries = () => {
        const entries = localStorage.getItem(STORAGE_KEY);
        return entries ? JSON.parse(entries) : [];
    };

    const saveEntries = (entries) => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    };
    
    // La fonction d'export reste la même

    const resetFormState = () => {
        emotionForm.reset();
        editEntryIdInput.value = ''; // Sortir du mode édition
        formTitle.textContent = "Nouvelle Entrée";
        emotionForm.querySelector('button[type="submit"]').textContent = 'Sauvegarder';
        emotionForm.querySelector('button[type="submit"]').classList.replace('btn-warning', 'btn-success');
        
        // Retirer le style spécial d'édition de toutes les entrées
        document.querySelectorAll('.journal-entry.editing').forEach(el => el.classList.remove('editing'));
    };

    const startEditEntry = (entryId) => {
        const entries = getEntries();
        const entryToEdit = entries.find(entry => entry.id.toString() === entryId);
        if (!entryToEdit) return;

        resetFormState(); // D'abord, on réinitialise tout

        // Remplir le formulaire avec les données de l'entrée
        editEntryIdInput.value = entryToEdit.id;
        if(entryToEdit.emotion) document.querySelector(`input[name="emotion"][value="${entryToEdit.emotion}"]`).checked = true;
        if(entryToEdit.intensity) document.querySelector(`input[name="intensity"][value="${entryToEdit.intensity}"]`).checked = true;
        
        ['trigger', 'reaction', 'context'].forEach(category => {
            if (entryToEdit[category + 's']) {
                entryToEdit[category + 's'].forEach(value => {
                    const checkbox = document.querySelector(`input[name="${category}"][value="${value}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        });

        document.getElementById('description').value = entryToEdit.description;

        // Mettre à jour l'UI pour le mode édition
        formTitle.textContent = "Modifier l'Entrée";
        const submitButton = emotionForm.querySelector('button[type="submit"]');
        submitButton.textContent = 'Sauvegarder les modifications';
        submitButton.classList.replace('btn-success', 'btn-warning');
        
        // Mettre en surbrillance l'entrée en cours d'édition
        document.querySelector(`[data-id="${entryId}"]`).closest('.journal-entry').classList.add('editing');

        // Remonter en haut du formulaire
        document.getElementById('top').scrollIntoView();
    };

    const renderJournal = () => {
        // ... Logique de rendu (ajout du bouton "Modifier") ...
        journalEntriesContainer.innerHTML = '';
        const entries = getEntries();

        if (entries.length === 0) {
            journalEntriesContainer.innerHTML = '<p class="text-center text-muted">Aucune entrée pour le moment. Ajoutez-en une !</p>';
            exportButton.style.display = 'none';
        } else {
            exportButton.style.display = 'inline-block';
        }

        entries.slice().reverse().forEach(entry => {
            const entryElement = document.createElement('div');
            entryElement.className = 'list-group-item list-group-item-action flex-column align-items-start mb-3 p-3 journal-entry';
            
            // ... (logique createBadges identique)
            const createBadges = (items) => {
                if (!items || items.length === 0) return '';
                return items.map(item => `<span class="badge bg-secondary me-1 mb-1">${item}</span>`).join(' ');
            };
            const triggersHtml = createBadges(entry.triggers);
            const reactionsHtml = createBadges(entry.reactions);
            const contextsHtml = createBadges(entry.contexts);

            entryElement.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">${entry.emotion}</h5>
                    <div>
                        <small class="text-muted me-3">${new Date(entry.id).toLocaleString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</small>
                        <button class="btn btn-sm btn-outline-secondary me-1 edit-btn" data-id="${entry.id}">Modifier</button>
                        <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${entry.id}">Supprimer</button>
                    </div>
                </div>
                <p class="mb-2"><strong>Intensité :</strong> <span class="badge bg-primary">${entry.intensity}</span></p>
                ${triggersHtml ? `<div class="mb-2"><strong>Déclencheur(s) :</strong> ${triggersHtml}</div>` : ''}
                ${reactionsHtml ? `<div class="mb-2"><strong>Réaction(s) :</strong> ${reactionsHtml}</div>` : ''}
                ${contextsHtml ? `<div class="mb-2"><strong>Contexte(s) :</strong> ${contextsHtml}</div>` : ''}
                ${entry.description ? `<p class="mb-1 mt-2 fst-italic text-muted">"${entry.description}"</p>` : ''}
            `;
            journalEntriesContainer.appendChild(entryElement);
        });
    };

    emotionForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const idToEdit = editEntryIdInput.value;

        const getCheckedValues = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);

        const entryData = {
            emotion: emotionForm.elements['emotion'].value,
            intensity: emotionForm.elements['intensity'].value,
            triggers: getCheckedValues('trigger'),
            reactions: getCheckedValues('reaction'),
            contexts: getCheckedValues('context'),
            description: emotionForm.elements['description'].value.trim()
        };

        if (!entryData.emotion || !entryData.intensity) {
            alert("Veuillez sélectionner une émotion et une intensité.");
            return;
        }
        
        let entries = getEntries();
        if (idToEdit) { // Mode Mise à jour
            const entryIndex = entries.findIndex(entry => entry.id.toString() === idToEdit);
            if (entryIndex > -1) {
                entries[entryIndex] = { ...entryData, id: parseInt(idToEdit) };
            }
        } else { // Mode Nouvelle entrée
            entries.push({ ...entryData, id: Date.now() });
        }

        saveEntries(entries);
        resetFormState();
        renderJournal();
    });

    journalEntriesContainer.addEventListener('click', (e) => {
        const target = e.target;
        if (target.classList.contains('delete-btn')) {
            const entryId = target.getAttribute('data-id');
            if (confirm("Êtes-vous sûr de vouloir supprimer cette entrée ?")) {
                let entries = getEntries();
                entries = entries.filter(entry => entry.id.toString() !== entryId);
                saveEntries(entries);
                renderJournal();
            }
        } else if (target.classList.contains('edit-btn')) {
            const entryId = target.getAttribute('data-id');
            startEditEntry(entryId);
        }
    });
    
    cancelButton.addEventListener('click', resetFormState);

    // Initialisation
    // exportButton.addEventListener('click', exportJournal); // N'oubliez pas de le rajouter
    renderJournal();
});
</script>
</body>
</html>
