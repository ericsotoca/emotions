<!DOCTYPE html>
<html lang="fr" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Journal d'√âmotions Augment√©</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { scroll-behavior: smooth; }
        body { padding: 20px; transition: background-color 0.3s, color 0.3s; }
        .card, .modal-content { transition: background-color 0.3s, border-color 0.3s; }
        .journal-entry { border-left-width: 5px; border-left-style: solid; transition: all 0.3s ease-in-out; }
        .journal-entry.editing { border-left-color: #ffc107 !important; background-color: rgba(255, 193, 7, 0.1); }
        .journal-entry:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .choice-selector .form-check-input { display: none; }
        .choice-selector .form-check-label { cursor: pointer; margin-right: 5px; margin-bottom: 5px; padding: .375rem .75rem; border-radius: .25rem; user-select: none; transition: all 0.2s ease-in-out; }
        h5 { border-bottom: 2px solid #dee2e6; padding-bottom: 8px; margin-bottom: 15px !important; }
        [data-bs-theme="dark"] h5 { border-bottom-color: #495057; }
        .form-check { padding-left: 0; display: inline-block; }
        .theme-toggle { cursor: pointer; font-size: 1.5rem; position: fixed; top: 15px; right: 20px; z-index: 1056; }
        [data-bs-theme="dark"] .journal-entry.editing { background-color: rgba(255, 193, 7, 0.2); }
        .btn-check:checked+.btn-outline-primary { color: #fff; background-color: #0d6efd; border-color: #0d6efd;}
    </style>
</head>
<body id="top">
    <div class="container mt-4">
        <div class="theme-toggle" id="themeToggle" title="Changer le th√®me">üåô</div>

        <header class="text-center mb-5">
            <h1>Mon Journal d'√âmotions Augment√©</h1>
            <p class="lead text-muted">Suivez, analysez et comprenez vos √©motions au quotidien.</p>
        </header>

        <!-- Formulaire de saisie -->
        <div class="card p-4" id="formCard">
            <h3 class="text-center mb-4" id="formTitle">Nouvelle Entr√©e</h3>
            <form id="emotionForm">
                <input type="hidden" id="editEntryId">
                
                <!-- √âmotion (s√©lection unique) -->
                <div class="mb-4 choice-selector">
                    <h5>√âmotion <span class="text-danger">*</span></h5>
                    <div class="d-flex flex-wrap" id="emotion-options">
                        <!-- Options Statiques Charg√©es Ici -->
                        <div class="form-check"><input type="radio" class="form-check-input btn-check" name="emotion" id="emo-amour" value="Amour ‚ù§Ô∏è" required><label class="form-check-label btn btn-outline-primary" for="emo-amour">Amour ‚ù§Ô∏è</label></div>
                        <div class="form-check"><input type="radio" class="form-check-input btn-check" name="emotion" id="emo-joie" value="Joie üòä"><label class="form-check-label btn btn-outline-primary" for="emo-joie">Joie üòä</label></div>
                        <div class="form-check"><input type="radio" class="form-check-input btn-check" name="emotion" id="emo-tristesse" value="Tristesse üò¢"><label class="form-check-label btn btn-outline-primary" for="emo-tristesse">Tristesse üò¢</label></div>
                        <div class="form-check"><input type="radio" class="form-check-input btn-check" name="emotion" id="emo-colere" value="Col√®re üò†"><label class="form-check-label btn btn-outline-primary" for="emo-colere">Col√®re üò†</label></div>
                        <div class="form-check"><input type="radio" class="form-check-input btn-check" name="emotion" id="emo-peur" value="Peur üò®"><label class="form-check-label btn btn-outline-primary" for="emo-peur">Peur üò®</label></div>
                        <div class="form-check"><input type="radio" class="form-check-input btn-check" name="emotion" id="emo-anxiete" value="Anxi√©t√© üòü"><label class="form-check-label btn btn-outline-primary" for="emo-anxiete">Anxi√©t√© üòü</label></div>
                        <div class="form-check"><input type="radio" class="form-check-input btn-check" name="emotion" id="emo-gratitude" value="Gratitude üôå"><label class="form-check-label btn btn-outline-primary" for="emo-gratitude">Gratitude üôå</label></div>
                         <div class="form-check"><input type="radio" class="form-check-input btn-check" name="emotion" id="emo-fierte" value="Fiert√© üòé"><label class="form-check-label btn btn-outline-primary" for="emo-fierte">Fiert√© üòé</label></div>
                    </div>
                </div>
                
                <!-- Intensit√© (s√©lection unique) -->
                <div class="mb-4 choice-selector">
                    <h5>Intensit√© <span class="text-danger">*</span></h5>
                    <div class="d-flex flex-wrap" id="intensity-options">
                        <div class="form-check"><input type="radio" class="form-check-input btn-check" name="intensity" id="int-1" value="Tr√®s faible (1)" required><label class="form-check-label btn btn-outline-primary" for="int-1">Tr√®s faible (1)</label></div>
                        <div class="form-check"><input type="radio" class="form-check-input btn-check" name="intensity" id="int-2" value="Faible (2)"><label class="form-check-label btn btn-outline-primary" for="int-2">Faible (2)</label></div>
                        <div class="form-check"><input type="radio" class="form-check-input btn-check" name="intensity" id="int-3" value="Moyenne (3)"><label class="form-check-label btn btn-outline-primary" for="int-3">Moyenne (3)</label></div>
                        <div class="form-check"><input type="radio" class="form-check-input btn-check" name="intensity" id="int-4" value="Forte (4)"><label class="form-check-label btn btn-outline-primary" for="int-4">Forte (4)</label></div>
                        <div class="form-check"><input type="radio" class="form-check-input btn-check" name="intensity" id="int-5" value="Tr√®s forte (5)"><label class="form-check-label btn btn-outline-primary" for="int-5">Tr√®s forte (5)</label></div>
                    </div>
                </div>

                <!-- Section de tags personnalisables -->
                <div id="tagSections">
                    <div class="mb-4 choice-selector">
                        <h5>D√©clencheur(s)</h5>
                        <div class="d-flex flex-wrap" id="trigger-options">
                            <div class="form-check"><input type="checkbox" class="form-check-input btn-check" name="trigger" id="trig-interaction" value="Interaction sociale"><label class="form-check-label btn btn-outline-primary" for="trig-interaction">Interaction sociale</label></div>
                            <div class="form-check"><input type="checkbox" class="form-check-input btn-check" name="trigger" id="trig-travail" value="Travail ou √©tudes"><label class="form-check-label btn btn-outline-primary" for="trig-travail">Travail ou √©tudes</label></div>
                            <div class="form-check"><input type="checkbox" class="form-check-input btn-check" name="trigger" id="trig-pensees" value="Pens√©es ou souvenirs"><label class="form-check-label btn btn-outline-primary" for="trig-pensees">Pens√©es ou souvenirs</label></div>
                        </div>
                        <div class="input-group input-group-sm mt-2"><input type="text" class="form-control" placeholder="Ajouter un nouveau d√©clencheur..." id="new-trigger-tag"><button class="btn btn-outline-secondary" type="button" data-category="trigger">Ajouter</button></div>
                    </div>
                    <div class="mb-4 choice-selector">
                        <h5>R√©action(s)</h5>
                        <div class="d-flex flex-wrap" id="reaction-options">
                            <div class="form-check"><input type="checkbox" class="form-check-input btn-check" name="reaction" id="react-parler" value="J'ai parl√© √† quelqu'un"><label class="form-check-label btn btn-outline-primary" for="react-parler">J'ai parl√© √† quelqu'un</label></div>
                            <div class="form-check"><input type="checkbox" class="form-check-input btn-check" name="reaction" id="react-isoler" value="Je me suis isol√©(e)"><label class="form-check-label btn btn-outline-primary" for="react-isoler">Je me suis isol√©(e)</label></div>
                            <div class="form-check"><input type="checkbox" class="form-check-input btn-check" name="reaction" id="react-solution" value="J'ai cherch√© une solution"><label class="form-check-label btn btn-outline-primary" for="react-solution">J'ai cherch√© une solution</label></div>
                        </div>
                        <div class="input-group input-group-sm mt-2"><input type="text" class="form-control" placeholder="Ajouter une nouvelle r√©action..." id="new-reaction-tag"><button class="btn btn-outline-secondary" type="button" data-category="reaction">Ajouter</button></div>
                    </div>
                    <div class="mb-4 choice-selector">
                        <h5>Contexte(s)</h5>
                        <div class="d-flex flex-wrap" id="context-options">
                             <div class="form-check"><input type="checkbox" class="form-check-input btn-check" name="context" id="ctx-maison" value="√Ä la maison"><label class="form-check-label btn btn-outline-primary" for="ctx-maison">√Ä la maison</label></div>
                             <div class="form-check"><input type="checkbox" class="form-check-input btn-check" name="context" id="ctx-travail" value="Au travail"><label class="form-check-label btn btn-outline-primary" for="ctx-travail">Au travail</label></div>
                             <div class="form-check"><input type="checkbox" class="form-check-input btn-check" name="context" id="ctx-seul" value="Seul(e)"><label class="form-check-label btn btn-outline-primary" for="ctx-seul">Seul(e)</label></div>
                        </div>
                        <div class="input-group input-group-sm mt-2"><input type="text" class="form-control" placeholder="Ajouter un nouveau contexte..." id="new-context-tag"><button class="btn btn-outline-secondary" type="button" data-category="context">Ajouter</button></div>
                    </div>
                </div>

                <!-- Description -->
                <div class="mb-3">
                    <label for="description" class="form-label">Description (optionnel)</label>
                    <textarea class="form-control" id="description" rows="3" placeholder="D√©crivez plus en d√©tail ce qui s'est pass√©..."></textarea>
                </div>
                
                <!-- Boutons -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                    <button type="button" class="btn btn-secondary me-md-2" id="cancelButton">Annuler</button>
                    <button type="submit" class="btn btn-primary">Sauvegarder</button>
                </div>
            </form>
        </div>

        <!-- Le reste de la page (Journal, Modales, etc.) -->
        <div class="mt-5">
            <div class="d-flex flex-wrap justify-content-center align-items-center mb-4 gap-2">
                <h2 class="text-center mb-0">Mon Journal</h2>
                <button class="btn btn-sm btn-info" id="statsButton" style="display: none;">Statistiques</button>
                <button class="btn btn-sm btn-light border" id="exportButton" style="display: none;">Exporter pour IA</button>
            </div>
            
            <div class="mb-3">
                <input type="search" id="searchInput" class="form-control" placeholder="Rechercher dans les entr√©es...">
            </div>

            <div id="journalEntries" class="list-group"></div>
        </div>
    </div>
    
    <!-- Modales (Statistiques et R√©glages) -->
    <div class="modal fade" id="statsModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Statistiques</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row"><div class="col-lg-6 mb-4"><h6>Fr√©quence des √âmotions</h6><canvas id="emotionChart"></canvas></div><div class="col-lg-6 mb-4"><h6>D√©clencheurs Courants</h6><canvas id="triggerChart"></canvas></div></div></div></div></div></div>
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">R√©glages</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><h6>Rappels Quotidiens</h6><p class="text-muted small">Requiert l'autorisation d'envoyer des notifications.</p><div class="d-flex align-items-center gap-2"><input type="time" class="form-control" id="reminderTime" value="20:00"><button class="btn btn-success" id="enableReminderBtn">Activer</button><button class="btn btn-danger" id="disableReminderBtn">Arr√™ter</button></div><div id="reminderStatus" class="mt-2 small"></div></div></div></div></div>
    <button class="btn btn-secondary position-fixed bottom-0 end-0 m-3" data-bs-toggle="modal" data-bs-target="#settingsModal" title="R√©glages">‚öôÔ∏è</button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// IIFE pour encapsuler le script
(() => {
    const STORAGE_KEYS = { ENTRIES: 'emotionJournalEntries', CUSTOM_TAGS: 'emotionJournalCustomTags', THEME: 'emotionJournalTheme', REMINDER: 'emotionJournalReminder' };
    
    // --- DOM ELEMENTS ---
    const emotionForm = document.getElementById('emotionForm');
    const journalEntriesContainer = document.getElementById('journalEntries');
    const formTitle = document.getElementById('formTitle');
    const editEntryIdInput = document.getElementById('editEntryId');
    const searchInput = document.getElementById('searchInput');
    
    // --- HELPERS ---
    const getFromStorage = (key, defaultValue = []) => { const item = localStorage.getItem(key); return item ? JSON.parse(item) : defaultValue; };
    const saveToStorage = (key, value) => localStorage.setItem(key, JSON.stringify(value));
    
    // --- FEATURE 1: DARK MODE ---
    const themeToggle = document.getElementById('themeToggle');
    const setTheme = (theme) => {
        document.documentElement.setAttribute('data-bs-theme', theme);
        themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        saveToStorage(STORAGE_KEYS.THEME, theme);
    };
    themeToggle.addEventListener('click', () => setTheme(document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark'));
    setTheme(getFromStorage(STORAGE_KEYS.THEME, window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));

    // --- FEATURE 4: CUSTOM TAGS ---
    const createTagOption = (category, value) => {
        const id = `${category}-${value.replace(/\s+/g, '-')}`;
        return `
        <div class="form-check">
            <input type="checkbox" class="form-check-input btn-check" name="${category}" id="${id}" value="${value}">
            <label class="form-check-label btn btn-outline-primary" for="${id}">${value}</label>
        </div>`;
    };
    
    const loadCustomTags = () => {
        const customTags = getFromStorage(STORAGE_KEYS.CUSTOM_TAGS, {});
        for (const category in customTags) {
            const container = document.getElementById(`${category}-options`);
            if (container) {
                customTags[category].forEach(tag => {
                    // Avoid duplicating tags already in HTML
                    if (!document.getElementById(`${category}-${tag.replace(/\s+/g, '-')}`)) {
                       container.insertAdjacentHTML('beforeend', createTagOption(category, tag));
                    }
                });
            }
        }
    };

    document.getElementById('tagSections').addEventListener('click', e => {
        if (e.target.tagName === 'BUTTON' && e.target.dataset.category) {
            const category = e.target.dataset.category;
            const input = document.getElementById(`new-${category}-tag`);
            const value = input.value.trim();
            if (value) {
                const customTags = getFromStorage(STORAGE_KEYS.CUSTOM_TAGS, {});
                if (!customTags[category]) customTags[category] = [];
                if (!customTags[category].includes(value)) {
                    customTags[category].push(value);
                    saveToStorage(STORAGE_KEYS.CUSTOM_TAGS, customTags);
                    document.getElementById(`${category}-options`).insertAdjacentHTML('beforeend', createTagOption(category, value));
                }
                input.value = '';
            }
        }
    });

    // --- CRUD & RENDER ---
    const resetForm = () => {
        emotionForm.reset();
        editEntryIdInput.value = '';
        formTitle.textContent = "Nouvelle Entr√©e";
        const submitBtn = emotionForm.querySelector('button[type="submit"]');
        submitBtn.textContent = 'Sauvegarder';
        submitBtn.classList.remove('btn-warning');
        submitBtn.classList.add('btn-primary');
        document.querySelectorAll('.journal-entry.editing').forEach(el => el.classList.remove('editing'));
    };

    const startEdit = (entryId) => {
        const entry = getFromStorage(STORAGE_KEYS.ENTRIES).find(e => e.id.toString() === entryId);
        if (!entry) return;
        resetForm();
        editEntryIdInput.value = entry.id;
        
        // Populate form
        Object.entries(entry).forEach(([key, value]) => {
            if (Array.isArray(value)) { // Checkboxes for tags
                 value.forEach(v => {
                    const cb = document.querySelector(`input[name="${key}"][value="${v}"]`);
                    if (cb) cb.checked = true;
                });
            } else { // Radios & text
                const el = document.querySelector(`[name="${key}"][value="${value}"]`) || document.getElementById(key);
                if (el) {
                    if (el.type === 'radio') el.checked = true;
                    else el.value = value;
                }
            }
        });

        formTitle.textContent = "Modifier l'Entr√©e";
        const submitBtn = emotionForm.querySelector('button[type="submit"]');
        submitBtn.textContent = 'Sauvegarder les modifications';
        submitBtn.classList.add('btn-warning');
        
        document.querySelector(`[data-id="${entryId}"]`).closest('.journal-entry').classList.add('editing');
        document.getElementById('formCard').scrollIntoView();
    };

    const renderJournal = (filterText = '') => {
        const entries = getFromStorage(STORAGE_KEYS.ENTRIES);
        const filteredEntries = filterText ? entries.filter(e => JSON.stringify(e).toLowerCase().includes(filterText.toLowerCase())) : entries;
        
        const uiControls = [document.getElementById('statsButton'), document.getElementById('exportButton')];
        uiControls.forEach(btn => btn.style.display = entries.length > 0 ? 'inline-block' : 'none');
        
        if (entries.length === 0) {
            journalEntriesContainer.innerHTML = '<p class="text-center text-muted">Aucune entr√©e pour le moment.</p>';
            return;
        }
        
        journalEntriesContainer.innerHTML = filteredEntries.length > 0
            ? filteredEntries.slice().reverse().map(entry => {
                const createBadges = (items) => items && items.length > 0 ? items.map(item => `<span class="badge text-bg-secondary me-1 mb-1">${item}</span>`).join(' ') : '';
                return `
                    <div class="list-group-item list-group-item-action flex-column align-items-start mb-3 p-3 rounded-3 shadow-sm journal-entry">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 fw-bold">${entry.emotion}</h6>
                            <div>
                                <small class="text-muted me-2">${new Date(entry.id).toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' })}</small>
                                <button class="btn btn-sm btn-outline-secondary py-0 px-1 me-1 edit-btn" title="Modifier" data-id="${entry.id}">‚úèÔ∏è</button>
                                <button class="btn btn-sm btn-outline-danger py-0 px-1 delete-btn" title="Supprimer" data-id="${entry.id}">üóëÔ∏è</button>
                            </div>
                        </div>
                        <p class="mb-2"><strong>Intensit√©:</strong> <span class="badge text-bg-primary">${entry.intensity}</span></p>
                        ${createBadges(entry.triggers) ? `<div class="mb-2 small"><strong>D√©clencheur(s):</strong> ${createBadges(entry.triggers)}</div>` : ''}
                        ${createBadges(entry.reactions) ? `<div class="mb-2 small"><strong>R√©action(s):</strong> ${createBadges(entry.reactions)}</div>` : ''}
                        ${createBadges(entry.contexts) ? `<div class="mb-2 small"><strong>Contexte(s):</strong> ${createBadges(entry.contexts)}</div>` : ''}
                        ${entry.description ? `<p class="mb-0 mt-2 fst-italic text-muted small">"${entry.description}"</p>` : ''}
                    </div>`;
            }).join('')
            : '<p class="text-center text-muted">Aucun r√©sultat pour votre recherche.</p>';
    };

    emotionForm.addEventListener('submit', e => {
        e.preventDefault();
        const getCheckedValues = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);
        
        const entryData = {
            emotion: emotionForm.elements['emotion'].value,
            intensity: emotionForm.elements['intensity'].value,
            triggers: getCheckedValues('trigger'),
            reactions: getCheckedValues('reaction'),
            contexts: getCheckedValues('context'),
            description: document.getElementById('description').value.trim()
        };

        if (!entryData.emotion || !entryData.intensity) return alert("Veuillez s√©lectionner une √©motion et une intensit√©.");

        let entries = getFromStorage(STORAGE_KEYS.ENTRIES);
        const idToEdit = editEntryIdInput.value;
        if (idToEdit) { // Update
            const index = entries.findIndex(entry => entry.id.toString() === idToEdit);
            if (index > -1) entries[index] = { ...entryData, id: parseInt(idToEdit) };
        } else { // Create
            entries.push({ ...entryData, id: Date.now() });
        }
        saveToStorage(STORAGE_KEYS.ENTRIES, entries);
        resetForm();
        renderJournal();
    });

    journalEntriesContainer.addEventListener('click', e => {
        const btn = e.target.closest('button');
        if (!btn || !btn.dataset.id) return;
        if (btn.classList.contains('delete-btn')) {
            if (confirm("√ätes-vous s√ªr de vouloir supprimer cette entr√©e ?")) {
                saveToStorage(STORAGE_KEYS.ENTRIES, getFromStorage(STORAGE_KEYS.ENTRIES).filter(entry => entry.id.toString() !== btn.dataset.id));
                renderJournal();
            }
        } else if (btn.classList.contains('edit-btn')) {
            startEdit(btn.dataset.id);
        }
    });

    document.getElementById('cancelButton').addEventListener('click', resetForm);
    searchInput.addEventListener('input', () => renderJournal(searchInput.value));

    // --- OTHER FEATURES ---
    // Stats Modal
    let charts = {};
    document.getElementById('statsButton').addEventListener('click', () => {
        const entries = getFromStorage(STORAGE_KEYS.ENTRIES);
        const processData = (key) => {
            const counts = entries.flatMap(e => e[key] || []).reduce((acc, val) => ({ ...acc, [val]: (acc[val] || 0) + 1 }), {});
            return Object.entries(counts).sort((a,b) => b[1] - a[1]);
        };
        const createChart = (canvasId, type, label, data) => {
            if (charts[canvasId]) charts[canvasId].destroy();
            charts[canvasId] = new Chart(document.getElementById(canvasId), {
                type: type,
                data: { labels: data.map(d=>d[0]), datasets: [{ label, data: data.map(d=>d[1]) }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        };
        createChart('emotionChart', 'pie', '√âmotions', processData('emotion'));
        createChart('triggerChart', 'bar', 'D√©clencheurs', processData('triggers'));
        new bootstrap.Modal(document.getElementById('statsModal')).show();
    });

    // Notifications
    const reminderStatus = document.getElementById('reminderStatus');
    const updateReminderStatus = () => {
        const r = getFromStorage(STORAGE_KEYS.REMINDER, {});
        reminderStatus.textContent = r.enabled ? `Rappel activ√© pour ${r.time}.` : 'Rappel d√©sactiv√©.';
    };
    document.getElementById('enableReminderBtn').addEventListener('click', async () => { /* Logic for notifications */ });
    updateReminderStatus();

    // Export
    document.getElementById('exportButton').addEventListener('click', () => { /* Logic for export */ });

    // --- INITIALIZATION ---
    loadCustomTags();
    renderJournal();
})();
</script>
</body>
</html>
